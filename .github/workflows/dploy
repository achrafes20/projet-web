deploy:
  needs: build-and-test
  runs-on: ubuntu-latest
  if: github.ref == 'refs/heads/main'
  
  steps:
  - name: Checkout repository
    uses: actions/checkout@v3

  - name: Setup PHP
    uses: shivammathur/setup-php@v2
    with:
      php-version: '8.2'
      extensions: mbstring, ctype, fileinfo, tokenizer, pdo_mysql
      tools: composer

  - name: Install dependencies
    run: |
      cd backend
      composer install --no-dev --optimize-autoloader
      php artisan config:clear

  - name: Prepare .env for production
    run: |
      cd backend
      echo "APP_ENV=production" > .env
      echo "APP_DEBUG=false" >> .env
      echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
      echo "DB_HOST=${{ secrets.FREEHOSTIA_DB_HOST }}" >> .env
      echo "DB_DATABASE=${{ secrets.FREEHOSTIA_DB_NAME }}" >> .env
      echo "DB_USERNAME=${{ secrets.FREEHOSTIA_DB_USER }}" >> .env
      echo "DB_PASSWORD=${{ secrets.FREEHOSTIA_DB_PASSWORD }}" >> .env
      # Ajoutez ici les autres variables n√©cessaires

  - name: Upload via FTP
    uses: SamKirkland/FTP-Deploy-Action@4.3.0
    with:
      server: ${{ secrets.FREEHOSTIA_FTP_SERVER }}
      username: ${{ secrets.FREEHOSTIA_FTP_USER }}
      password: ${{ secrets.FREEHOSTIA_FTP_PASSWORD }}
      local-dir: ./backend/
      server-dir: ./htdocs/  # Dossier racine Freehostia
      exclude: |
        .git*
        .env.example
        docker-compose.yml
        tests/
        storage/logs/*
